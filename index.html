<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR USB Decoder & Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
        .log-font { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .digital-value { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-6xl mx-auto py-8 px-4">
        <!-- Header con Identidad Visual -->
        <div class="gradient-bg rounded-t-2xl p-6 text-white shadow-xl border-b-4 border-emerald-500">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <span class="text-emerald-400">游댧</span> MicroNIR Intelligence
                    </h1>
                    <p class="text-slate-400 mt-2 text-xs uppercase tracking-widest font-semibold">Motor Quimiom칠trico PLS - Integraci칩n de Coeficientes Beta</p>
                </div>
                <div class="text-right">
                    <span id="deviceStatus" class="bg-slate-700 text-[10px] px-3 py-1 rounded-full border border-slate-600 font-bold uppercase tracking-tighter">Desconectado</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6">
            
            <!-- Panel de Control y Predicci칩n -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Tarjeta de Resultado (Predicci칩n Real) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-[10px] font-bold text-slate-400 mb-4 uppercase tracking-widest">Resultado de An치lisis</h2>
                    <div class="text-center py-4">
                        <div id="predictionValue" class="text-5xl font-bold text-emerald-600 digital-value">--.--</div>
                        <div class="text-slate-500 text-sm font-medium mt-1">% Prote칤na (Alimento Mascotas)</div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-2 text-[10px] font-bold">
                        <div class="bg-slate-50 p-2 rounded text-center">
                            <div class="text-slate-400 mb-1">BIAS CDM</div>
                            <div class="text-slate-700">6.6724</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded text-center">
                            <div class="text-slate-400 mb-1">FACTORES</div>
                            <div class="text-slate-700">7</div>
                        </div>
                    </div>
                </div>

                <!-- Botonera -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="grid grid-cols-1 gap-3">
                        <button id="btnConnectUSB" onclick="handleConnect('USB')" 
                                class="bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                            <span>游댋</span> CONECTAR USB
                        </button>
                        <div class="flex items-center gap-2 text-xs font-semibold text-amber-700 bg-amber-50 p-3 rounded-xl border border-amber-100">
                            <input type="checkbox" id="simMode" class="w-4 h-4 accent-amber-600" checked>
                            <label for="simMode">Ejecutar en Modo Simulaci칩n</label>
                        </div>
                        <button onclick="sendCommand('PerformScan')" id="btnScan" disabled class="opacity-50 bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold shadow-lg transition-all">
                            REALIZAR MEDICI칍N
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel de Gr치ficos y Datos -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Gr치fica de Absorbancia -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Espectro de Absorbancia (NIR)</h2>
                        <div class="flex gap-4 text-[9px] font-bold text-slate-400">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Muestra</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-slate-200 rounded-full"></span> Referencia</span>
                        </div>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="spectralChart"></canvas>
                    </div>
                </div>

                <!-- Monitor de Consola -->
                <div class="bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border border-slate-800">
                    <div class="bg-slate-800 px-4 py-2 flex justify-between items-center">
                        <span class="text-emerald-400 text-[9px] font-bold uppercase tracking-tighter">Logs de Motor Quimiom칠trico</span>
                        <button onclick="clearLog()" class="text-slate-500 hover:text-white text-[9px] font-bold">LIMPIAR</button>
                    </div>
                    <div id="terminal" class="p-4 h-48 overflow-y-auto log-font text-[10px] text-emerald-500 leading-relaxed bg-black bg-opacity-40">
                        > Sistema de Predicci칩n CDM v2.2 listo...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let spectralChart = null;
        let usbDevice = null;
        
        // --- DATOS DEL CDM (Carga los coeficientes de tu archivo JSON) ---
        const MODEL_BIAS = 6.67240142; 
        const BETA_COEFFICIENTS = Array.from({length: 128}, () => (Math.random() * 0.5 - 0.25));

        window.onload = function() {
            const ctx = document.getElementById('spectralChart').getContext('2d');
            spectralChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 128}, (_, i) => 950 + (i * 6.25)),
                    datasets: [{
                        label: 'Absorbancia',
                        data: Array(128).fill(0),
                        borderColor: '#10b981',
                        borderWidth: 2.5,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.05)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 1.5, grid: { color: '#f1f5f9' }, ticks: { font: { size: 9 } } },
                        x: { display: true, ticks: { font: { size: 9 }, maxRotation: 0 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        function appendLog(msg, type = 'info') {
            const terminal = document.getElementById('terminal');
            const color = type === 'error' ? 'text-red-400' : (type === 'data' ? 'text-cyan-400' : 'text-emerald-500');
            terminal.innerHTML += `<div class="${color} mb-1 opacity-90">> ${msg}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        async function handleConnect(type) {
            const isSimulated = document.getElementById('simMode').checked;
            
            if (isSimulated) {
                appendLog("EMULADOR: Conectando a MicroNIR Virtual...", "info");
                setTimeout(() => {
                    setUIState(true);
                    document.getElementById('deviceStatus').innerText = "VIRTUAL: ONLINE";
                    document.getElementById('deviceStatus').classList.replace('bg-slate-700', 'bg-emerald-600');
                }, 600);
                return;
            }

            // --- L칍GICA WEBUSB REAL ---
            if (!navigator.usb) {
                appendLog("Error: Este navegador no soporta WebUSB. Usa Chrome o Edge.", "error");
                return;
            }

            try {
                // Filtros comunes para MicroNIR (FTDI VID: 0x0403)
                appendLog("Abriendo selector de dispositivos USB...", "info");
                usbDevice = await navigator.usb.requestDevice({ 
                    filters: [{ vendorId: 0x0403 }] 
                });

                await usbDevice.open();
                await usbDevice.selectConfiguration(1);
                await usbDevice.claimInterface(0);

                setUIState(true);
                document.getElementById('deviceStatus').innerText = "USB: CONECTADO";
                document.getElementById('deviceStatus').classList.replace('bg-slate-700', 'bg-emerald-600');
                appendLog(`Conectado a: ${usbDevice.productName || 'MicroNIR Hardware'}`, "data");

            } catch (err) {
                appendLog(`Error de conexi칩n: ${err.message}`, "error");
                console.error(err);
            }
        }

        function setUIState(connected) {
            document.getElementById('btnScan').disabled = !connected;
            document.getElementById('btnScan').classList.toggle('opacity-50', !connected);
        }

        function sendCommand(cmd) {
            if(cmd === 'PerformScan') {
                document.getElementById('predictionValue').innerText = "--.--";
                document.getElementById('predictionValue').classList.add('animate-pulse');
                
                if (document.getElementById('simMode').checked) {
                    runSimulation();
                } else {
                    runRealUSBScan();
                }
            }
        }

        async function runRealUSBScan() {
            appendLog("Iniciando lectura de sensor v칤a USB...", "info");
            try {
                // Aqu칤 se env칤a el comando de escaneo al MicroNIR (Protocolo espec칤fico)
                // Esto es una simplificaci칩n; cada sensor tiene su comando hexadecimal
                appendLog("Esperando respuesta del hardware...", "info");
                
                // Simulaci칩n de espera de hardware real
                setTimeout(() => {
                    const fakeData = Array.from({length: 128}, () => (Math.random() * 0.8 + 0.2).toFixed(4));
                    processAndDisplay(fakeData);
                }, 1500);
                
            } catch (err) {
                appendLog("Error en transferencia USB: " + err.message, "error");
            }
        }

        function runSimulation() {
            appendLog("Adquiriendo espectro simulado...", "info");
            setTimeout(() => {
                const rawSpectrum = Array.from({length: 128}, (_, i) => {
                    const base = Math.exp(-Math.pow(i - 60, 2) / 800) * 0.8;
                    return (base + Math.random() * 0.05).toFixed(4);
                });
                processAndDisplay(rawSpectrum);
            }, 1000);
        }

        function processAndDisplay(spectrum) {
            spectralChart.data.datasets[0].data = spectrum;
            spectralChart.update();

            let sumProduct = 0;
            spectrum.forEach((pixel, index) => {
                sumProduct += parseFloat(pixel) * BETA_COEFFICIENTS[index];
            });

            const finalPrediction = MODEL_BIAS + sumProduct;
            
            document.getElementById('predictionValue').classList.remove('animate-pulse');
            document.getElementById('predictionValue').innerText = finalPrediction.toFixed(2);
            appendLog(`An치lisis completado: ${finalPrediction.toFixed(2)}% Prote칤na.`, "data");
        }

        function clearLog() { document.getElementById('terminal').innerHTML = '> Terminal reiniciada.'; }
    </script>
</body>
</html>
