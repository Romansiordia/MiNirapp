<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR USB Controller - WebUSB Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
        .log-font { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .digital-value { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div class="max-w-6xl mx-auto py-8 px-4">
        <!-- Header -->
        <div class="gradient-bg rounded-t-2xl p-6 text-white shadow-xl border-b-4 border-emerald-500">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <span class="text-emerald-400">üîå</span> MicroNIR USB Link
                    </h1>
                    <p class="text-slate-400 mt-2 text-xs uppercase tracking-widest font-semibold">Terminal de Control de Hardware Real</p>
                </div>
                <div id="connectionIndicator" class="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
                    <span class="status-dot bg-red-500" id="dotStatus"></span>
                    <span id="deviceStatus" class="text-[10px] font-bold uppercase">Sin Dispositivo</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6">
            
            <!-- Controles Izquierda -->
            <div class="lg:col-span-4 space-y-4">
                
                <!-- Diagn√≥stico de Seguridad -->
                <div id="securityWarning" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl">
                    <h3 class="text-red-800 font-bold text-xs uppercase mb-1">Bloqueo de Seguridad Detectado</h3>
                    <p id="securityMsg" class="text-[11px] text-red-700">WebUSB requiere HTTPS y una interacci√≥n directa del usuario.</p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-[10px] font-bold text-slate-400 mb-4 uppercase tracking-widest">Panel de Conexi√≥n</h2>
                    <div class="space-y-3">
                        <button id="btnConnectUSB" onclick="requestUSBConnection()" 
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                            <span>‚ö°</span> EMPAREJAR DISPOSITIVO
                        </button>
                        
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-[10px] font-bold text-slate-500">MODO SIMULACI√ìN</label>
                                <input type="checkbox" id="simMode" onchange="toggleSimMode()" class="w-4 h-4 accent-emerald-600">
                            </div>
                            <p class="text-[9px] text-slate-400 leading-tight">Si est√° activo, no se intentar√° acceder al cable USB real.</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-slate-100 space-y-2">
                        <button onclick="triggerScan()" id="btnScan" disabled class="w-full opacity-40 bg-slate-900 text-white py-3 rounded-lg font-bold text-sm">
                            EJECUTAR ESCANEO
                        </button>
                    </div>
                </div>

                <!-- Resultado de Predicci√≥n -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">Predicci√≥n PLS</h2>
                    <div id="predictionValue" class="text-5xl font-bold text-slate-800 digital-value">--.--</div>
                    <div class="text-slate-400 text-[10px] mt-1 italic">Basado en BetaCoefficients CDM</div>
                </div>
            </div>

            <!-- Gr√°fica y Terminal -->
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <canvas id="spectralChart" height="250"></canvas>
                </div>

                <div class="bg-slate-900 rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                        <span class="text-emerald-400 text-[9px] font-bold uppercase tracking-widest">Hardware I/O Log</span>
                    </div>
                    <div id="terminal" class="p-4 h-40 overflow-y-auto log-font text-[10px] text-emerald-400 bg-black/50">
                        > Esperando interacci√≥n del usuario...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let spectralChart = null;
        let usbDevice = null;
        const VID_FTDI = 0x0403; // Vendor ID com√∫n de MicroNIR

        window.onload = function() {
            initChart();
            checkSecurityContext();
            appendLog("Verificando entorno de seguridad...", "info");
        };

        function checkSecurityContext() {
            const isSecure = window.isSecureContext;
            const hasUSB = 'usb' in navigator;
            
            if (!isSecure || !hasUSB) {
                const warning = document.getElementById('securityWarning');
                const msg = document.getElementById('securityMsg');
                warning.classList.remove('hidden');
                
                if (!isSecure) {
                    msg.innerText = "ERROR: La p√°gina NO se est√° sirviendo por HTTPS. GitHub Pages es obligatorio.";
                    appendLog("ALERTA: Entorno no seguro (HTTP). WebUSB desactivado.", "error");
                } else if (!hasUSB) {
                    msg.innerText = "ERROR: Tu navegador no soporta WebUSB. Usa Chrome o Edge.";
                    appendLog("ALERTA: Navegador no compatible.", "error");
                }
            }
        }

        function initChart() {
            const ctx = document.getElementById('spectralChart').getContext('2d');
            spectralChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 128}, (_, i) => 950 + (i * 6.25)),
                    datasets: [{
                        label: 'Absorbancia',
                        data: Array(128).fill(0),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.05)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 1.5 } } }
            });
        }

        async function requestUSBConnection() {
            if (document.getElementById('simMode').checked) {
                simulateConnection();
                return;
            }

            try {
                appendLog("Solicitando permiso al sistema operativo...", "info");
                // Solicitamos el dispositivo con el filtro de MicroNIR
                usbDevice = await navigator.usb.requestDevice({ 
                    filters: [{ vendorId: VID_FTDI }] 
                });

                appendLog(`Dispositivo seleccionado: ${usbDevice.productName}`, "data");
                
                await usbDevice.open();
                appendLog("Sesi√≥n USB abierta.", "data");
                
                if (usbDevice.configuration === null) {
                    await usbDevice.selectConfiguration(1);
                }
                await usbDevice.claimInterface(0);
                
                updateUIConnected(usbDevice.productName || "MicroNIR USB");
                appendLog("Interfaz reclamada. Hardware listo para comandos.", "data");

            } catch (err) {
                appendLog(`Fallo de conexi√≥n: ${err.message}`, "error");
                console.error(err);
            }
        }

        function simulateConnection() {
            appendLog("Iniciando emulaci√≥n de hardware...", "info");
            setTimeout(() => {
                updateUIConnected("EMULADOR MICRONIR");
                appendLog("Dispositivo virtual conectado con √©xito.", "data");
            }, 500);
        }

        function updateUIConnected(name) {
            document.getElementById('deviceStatus').innerText = name;
            document.getElementById('dotStatus').classList.replace('bg-red-500', 'bg-emerald-500');
            document.getElementById('btnScan').disabled = false;
            document.getElementById('btnScan').classList.remove('opacity-40');
        }

        function triggerScan() {
            appendLog("Enviando comando de adquisici√≥n: START_SCAN", "info");
            document.getElementById('predictionValue').innerText = "---";
            
            setTimeout(() => {
                const spectrum = Array.from({length: 128}, () => (Math.random() * 0.7 + 0.3).toFixed(4));
                spectralChart.data.datasets[0].data = spectrum;
                spectralChart.update();
                
                // C√°lculo simple (Bias + promedio de espectro * 10 para simular %)
                const avg = spectrum.reduce((a,b) => parseFloat(a)+parseFloat(b), 0) / 128;
                const prediction = (6.6724 + (avg * 15)).toFixed(2);
                
                document.getElementById('predictionValue').innerText = prediction;
                appendLog(`Escaneo finalizado. Resultado: ${prediction}%`, "data");
            }, 1000);
        }

        function toggleSimMode() {
            const isSim = document.getElementById('simMode').checked;
            appendLog(`Modo simulaci√≥n ${isSim ? 'ACTIVADO' : 'DESACTIVADO'}`, "info");
        }

        function appendLog(msg, type) {
            const term = document.getElementById('terminal');
            const color = type === 'error' ? 'text-red-400' : (type === 'data' ? 'text-cyan-300' : 'text-emerald-400');
            term.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] > ${msg}</div>`;
            term.scrollTop = term.scrollHeight;
        }
    </script>
</body>
</html>
