<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR Controller - Maíz PLS</title>
    <!-- Cargando Tailwind CSS y Chart.js desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white font-sans p-4">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">MicroNIR <span class="text-white">Analysis</span></h1>
                <p class="text-gray-400">Control de Sensor y Modelo de Maíz</p>
            </div>
            <div id="statusIndicator" class="px-4 py-2 rounded-full bg-red-900/30 border border-red-500 text-red-400 text-sm">
                Desconectado
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-4">
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-4">Dispositivo</h2>
                    <button id="btnConnect" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all mb-3">
                        Conectar Sensor
                    </button>
                    <button id="btnScan" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50" disabled>
                        Iniciar Escaneo
                    </button>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="simMode" class="form-checkbox h-5 w-5 text-blue-600" checked>
                            <span class="text-gray-300">Modo Simulación</span>
                        </label>
                    </div>
                </div>

                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-2 text-center">Resultado</h2>
                    <div id="resultValue" class="text-5xl font-mono text-center py-4 text-blue-400">--</div>
                    <p class="text-center text-gray-400 text-sm">Valor Predicho (PLS)</p>
                </div>
            </div>

            <div class="md:col-span-2 space-y-4">
                <div class="card p-6 rounded-2xl">
                    <canvas id="spectrumChart" height="250"></canvas>
                </div>
                <div id="log" class="bg-black/50 p-4 rounded-xl font-mono text-xs text-green-400 h-32 overflow-y-auto border border-white/10">
                    > Listo para iniciar...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Coeficientes y configuración del modelo
        const BIAS = -1.6224;
        const BETA_COEFFICIENTS = Array(128).fill(0).map(() => (Math.random() * 0.2) - 0.1); 

        let device;
        let chart;

        function addLog(msg, isError = false) {
            const logDiv = document.getElementById('log');
            if (logDiv) {
                const colorClass = isError ? 'text-red-400' : 'text-green-400';
                logDiv.innerHTML += `<div class="${colorClass}">> ${msg}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        const ctx = document.getElementById('spectrumChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 128}, (_, i) => 900 + (i * 6.25)),
                datasets: [{
                    label: 'Absorbancia',
                    borderColor: '#60a5fa',
                    borderWidth: 2,
                    data: Array(128).fill(0),
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                    x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                }
            }
        });

        async function connectDevice() {
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x0403 }] });
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(0);
                
                document.getElementById('statusIndicator').textContent = "Conectado";
                document.getElementById('statusIndicator').className = "px-4 py-2 rounded-full bg-green-900/30 border border-green-500 text-green-400 text-sm";
                document.getElementById('btnScan').disabled = false;
                addLog("Sensor detectado y reclamado correctamente.");
                
                await device.controlTransferOut({
                    requestType: 'vendor', recipient: 'device', request: 0x01, value: 0x0001, index: 0x0000
                });
                addLog("Comando de encendido enviado.");
            } catch (err) {
                addLog("Error conexión: " + err.message, true);
            }
        }

        async function performScan() {
            const isSim = document.getElementById('simMode').checked;
            let spectrumData = new Float32Array(128);

            if (isSim) {
                addLog("Ejecutando simulación...");
                spectrumData = spectrumData.map(() => Math.random() * 0.8);
            } else {
                try {
                    // Limpieza previa del buffer por si hay datos residuales
                    await device.transferIn(1, 64).catch(() => {});

                    addLog("Iniciando integración en hardware...");
                    await device.controlTransferOut({
                        requestType: 'vendor', recipient: 'device', request: 0x02, value: 0x0000, index: 0x0000
                    });

                    let result;
                    let retries = 3;
                    let success = false;

                    // Lógica de reintento para esperar al sensor lento
                    while (retries > 0 && !success) {
                        const waitTime = 2000; // 2 segundos entre intentos
                        addLog(`Esperando procesamiento (${waitTime}ms)...`);
                        await new Promise(r => setTimeout(r, waitTime));

                        addLog("Solicitando espectro...");
                        result = await device.transferIn(1, 256);

                        if (result.data.byteLength >= 256) {
                            success = true;
                        } else {
                            const hex = Array.from(new Uint8Array(result.data.buffer))
                                             .map(b => b.toString(16).padStart(2, '0'))
                                             .join(' ');
                            addLog(`Sensor ocupado (${hex}). Reintentando...`, true);
                            retries--;
                        }
                    }

                    if (!success) {
                        addLog("ERROR: Tiempo de espera agotado. El sensor no entregó datos.", true);
                        return;
                    }

                    const view = new DataView(result.data.buffer);
                    for (let i = 0; i < 128; i++) {
                        spectrumData[i] = view.getUint16(i * 2, true) / 65535.0;
                    }
                    addLog("Espectro recibido correctamente.");
                } catch (err) {
                    addLog("Error lectura: " + err.message, true);
                    return;
                }
            }
            updateUI(spectrumData);
        }

        function updateUI(data) {
            chart.data.datasets[0].data = Array.from(data);
            chart.update();

            let prediction = BIAS;
            for (let i = 0; i < 128; i++) {
                prediction += data[i] * BETA_COEFFICIENTS[i];
            }
            document.getElementById('resultValue').textContent = prediction.toFixed(4);
        }

        document.getElementById('btnConnect').addEventListener('click', connectDevice);
        document.getElementById('btnScan').addEventListener('click', performScan);
    </script>
</body>
</html>
