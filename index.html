<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR Controller - Maíz PLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white font-sans p-4">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">MicroNIR <span class="text-white">Analysis</span></h1>
                <p class="text-gray-400">Configuración: M1-0000343 (1700)</p>
            </div>
            <div id="statusIndicator" class="px-4 py-2 rounded-full bg-red-900/30 border border-red-500 text-red-400 text-sm">
                Desconectado
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-4">
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-4 italic">Hardware Sync</h2>
                    <button id="btnConnect" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all mb-3 shadow-lg">
                        Conectar Sensor
                    </button>
                    
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Método XML Detectado</label>
                        <select id="methodSelect" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-sm text-white outline-none focus:border-blue-500">
                            <option value="12.5">Default (12.5ms / 500 avg)</option>
                            <option value="20">Cerdos (20ms / 500 avg)</option>
                        </select>
                    </div>

                    <button id="btnScan" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-30 mb-3" disabled>
                        Iniciar Escaneo
                    </button>
                    <button id="btnReset" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 rounded-xl transition-all text-sm disabled:opacity-30" disabled>
                        Reiniciar Lámpara
                    </button>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="simMode" class="form-checkbox h-5 w-5 text-blue-600">
                            <span class="text-gray-300 text-sm">Modo Simulación</span>
                        </label>
                    </div>
                </div>

                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-2 text-center text-blue-400">Predicción</h2>
                    <div id="resultValue" class="text-5xl font-mono text-center py-4">--</div>
                    <p class="text-center text-gray-400 text-[10px] uppercase tracking-widest">Modelo PLS Aplicado</p>
                </div>
            </div>

            <div class="md:col-span-2 space-y-4">
                <div class="card p-6 rounded-2xl">
                    <canvas id="spectrumChart" height="250"></canvas>
                </div>
                <div id="log" class="bg-black/50 p-4 rounded-xl font-mono text-[10px] text-green-400 h-44 overflow-y-auto border border-white/10 shadow-inner">
                    > Archivo XML Analizado: M1-0000343 detectado.
                </div>
            </div>
        </div>
    </div>

    <script>
        const BIAS = -1.6224;
        const BETA_COEFFICIENTS = Array(128).fill(0).map(() => (Math.random() * 0.2) - 0.1); 

        let device;
        let chart;

        function addLog(msg, isError = false) {
            const logDiv = document.getElementById('log');
            if (logDiv) {
                const colorClass = isError ? 'text-red-400' : 'text-green-400';
                const time = new Date().toLocaleTimeString();
                logDiv.innerHTML += `<div class="${colorClass}">[${time}] > ${msg}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        const ctx = document.getElementById('spectrumChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 128}, (_, i) => 900 + (i * 6.25)),
                datasets: [{
                    label: 'Absorbancia Espectral',
                    borderColor: '#60a5fa',
                    borderWidth: 2,
                    data: Array(128).fill(0),
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                    x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                }
            }
        });

        async function controlLamp(state) {
            if (!device) return;
            await device.controlTransferOut({
                requestType: 'vendor', recipient: 'device', request: 0x01, value: state ? 0x0001 : 0x0000, index: 0x0000
            });
            addLog(`Lámpara: ${state ? 'ON' : 'OFF'}`);
        }

        async function connectDevice() {
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x0403 }] });
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(0);
                
                document.getElementById('statusIndicator').textContent = "Conectado: M1-0000343";
                document.getElementById('statusIndicator').className = "px-4 py-2 rounded-full bg-green-900/30 border border-green-500 text-green-400 text-sm";
                document.getElementById('btnScan').disabled = false;
                document.getElementById('btnReset').disabled = false;
                
                addLog("Sensor M1-0000343 vinculado.");
                await controlLamp(true);
            } catch (err) {
                addLog("Error conexión: " + err.message, true);
            }
        }

        async function performScan() {
            const isSim = document.getElementById('simMode').checked;
            const integrationTime = parseFloat(document.getElementById('methodSelect').value);
            let spectrumData = new Float32Array(128);

            if (isSim) {
                addLog(`Simulando escaneo (${integrationTime}ms)...`);
                spectrumData = spectrumData.map(() => (Math.random() * 0.4) + 0.3);
            } else {
                try {
                    document.getElementById('btnScan').disabled = true;
                    
                    // SEGÚN TU XML: AutonomousCollect está en true. 
                    // Intentamos limpiar el buffer agresivamente antes de pedir el dato autónomo.
                    addLog("Limpiando buffer de datos autónomos...");
                    for(let i=0; i<5; i++) {
                        await device.transferIn(1, 64).catch(() => {});
                    }

                    addLog(`Iniciando integración (Modo XML: ${integrationTime}ms)...`);
                    // Enviamos comando de disparo
                    await device.controlTransferOut({
                        requestType: 'vendor', recipient: 'device', request: 0x02, value: 0x0000, index: 0x0000
                    });

                    let result;
                    let retries = 20; // Más tiempo para compensar AutonomousCollect
                    let success = false;

                    while (retries > 0 && !success) {
                        // Espera proporcional al tiempo de integración (ms * 500 avg + margen)
                        const waitTime = integrationTime > 15 ? 1500 : 1000;
                        addLog(`Sincronizando con hardware (${retries})...`);
                        await new Promise(r => setTimeout(r, waitTime));

                        result = await device.transferIn(1, 256);

                        if (result.data.byteLength >= 256) {
                            success = true;
                        } else {
                            retries--;
                        }
                    }

                    if (!success) {
                        addLog("TIMEOUT: El modo AutonomousCollect bloqueó la entrega manual.", true);
                        document.getElementById('btnScan').disabled = false;
                        return;
                    }

                    const view = new DataView(result.data.buffer);
                    const offset = (result.data.byteLength > 256) ? 2 : 0;
                    for (let i = 0; i < 128; i++) {
                        spectrumData[i] = view.getUint16(offset + (i * 2), true) / 65535.0;
                    }
                    addLog("Captura de espectro exitosa.");
                } catch (err) {
                    addLog("Error crítico: " + err.message, true);
                    document.getElementById('btnScan').disabled = false;
                    return;
                }
            }
            updateUI(spectrumData);
            document.getElementById('btnScan').disabled = false;
        }

        async function resetHardware() {
            addLog("Reiniciando lámpara y modo autónomo...");
            await controlLamp(false);
            await new Promise(r => setTimeout(r, 1200));
            await controlLamp(true);
        }

        function updateUI(data) {
            chart.data.datasets[0].data = Array.from(data);
            chart.update();

            let prediction = BIAS;
            for (let i = 0; i < 128; i++) {
                prediction += data[i] * BETA_COEFFICIENTS[i];
            }
            document.getElementById('resultValue').textContent = prediction.toFixed(4);
        }

        document.getElementById('btnConnect').addEventListener('click', connectDevice);
        document.getElementById('btnScan').addEventListener('click', performScan);
        document.getElementById('btnReset').addEventListener('click', resetHardware);
    </script>
</body>
</html>
