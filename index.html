<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR USB Controller - WebUSB Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
        .log-font { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .digital-value { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div class="max-w-6xl mx-auto py-8 px-4">
        <!-- Header -->
        <div class="gradient-bg rounded-t-2xl p-6 text-white shadow-xl border-b-4 border-emerald-500">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <span class="text-emerald-400">ðŸ”Œ</span> MicroNIR USB Link
                    </h1>
                    <p class="text-slate-400 mt-2 text-xs uppercase tracking-widest font-semibold">Motor de PredicciÃ³n PLS Activo</p>
                </div>
                <div id="connectionIndicator" class="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
                    <span class="status-dot bg-red-500" id="dotStatus"></span>
                    <span id="deviceStatus" class="text-[10px] font-bold uppercase">Sin Dispositivo</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6">
            
            <!-- Controles Izquierda -->
            <div class="lg:col-span-4 space-y-4">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-[10px] font-bold text-slate-400 mb-4 uppercase tracking-widest text-center">Modelo: Alimento Mascotas (PLS)</h2>
                    <div class="space-y-3">
                        <button id="btnConnectUSB" onclick="requestUSBConnection()" 
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                            <span>âš¡</span> EMPAREJAR DISPOSITIVO
                        </button>
                        
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-[10px] font-bold text-slate-500">MODO SIMULACIÃ“N</label>
                                <input type="checkbox" id="simMode" onchange="toggleSimMode()" class="w-4 h-4 accent-emerald-600">
                            </div>
                            <p class="text-[9px] text-slate-400 leading-tight">Usa este modo si no tienes el hardware conectado para probar la interfaz.</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-slate-100 space-y-2 text-center">
                        <button onclick="triggerScan()" id="btnScan" disabled class="w-full opacity-40 bg-slate-900 text-white py-4 rounded-xl font-bold text-sm shadow-md hover:scale-[1.02] transition-transform">
                            EJECUTAR ESCANEO REAL
                        </button>
                        <p class="text-[10px] text-slate-400 mt-2 italic">Aplica Bias: 6.6724</p>
                    </div>
                </div>

                <!-- Resultado de PredicciÃ³n -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
                    <h2 class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">Resultado de PredicciÃ³n</h2>
                    <div id="predictionValue" class="text-6xl font-bold text-slate-800 digital-value">--.--</div>
                    <div id="unitLabel" class="text-slate-400 text-[10px] mt-1 font-bold">VALOR CALCULADO %</div>
                </div>
            </div>

            <!-- GrÃ¡fica y Terminal -->
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                    <div class="absolute top-4 right-6 text-[9px] font-bold text-slate-300 uppercase tracking-tighter">Espectro de Absorbancia (950-1650nm)</div>
                    <canvas id="spectralChart" height="280"></canvas>
                </div>

                <div class="bg-slate-900 rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                        <span class="text-emerald-400 text-[9px] font-bold uppercase tracking-widest flex items-center gap-2">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                            </span>
                            Hardware I/O Log
                        </span>
                        <button onclick="clearLog()" class="text-[8px] text-slate-400 hover:text-white uppercase font-bold tracking-widest">Clear Buffer</button>
                    </div>
                    <div id="terminal" class="p-4 h-44 overflow-y-auto log-font text-[10px] text-emerald-400 bg-black/50 leading-relaxed">
                        > Sistema listo. Verificado entorno de seguridad WebUSB.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES DEL MODELO CDM (Basado en tu archivo "Alimento Mascotas") ---
        const MODEL_BIAS = 6.67240142;
        // Coeficientes Beta truncados para el ejemplo (en una app real pondrÃ­amos los 128)
        const BETA_COEFFICIENTS = [
            -0.124, 0.045, 0.892, -0.342, 0.112, 0.543, -0.098, 0.221,
            0.150, -0.050, 0.120, 0.340, -0.210, 0.090, 0.450, -0.120,
            0.080, -0.040, 0.320, 0.110, -0.090, 0.060, 0.230, -0.150,
            // ... AquÃ­ irÃ­an los 128 valores exactos del JSON
        ];

        let spectralChart = null;
        let usbDevice = null;
        const VID_FTDI = 0x0403; 

        window.onload = function() {
            initChart();
            appendLog("Verificando protocolo WebUSB...", "info");
        };

        function initChart() {
            const ctx = document.getElementById('spectralChart').getContext('2d');
            spectralChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 128}, (_, i) => (950 + (i * 5.46)).toFixed(0)),
                    datasets: [{
                        label: 'Absorbancia (log 1/R)',
                        data: Array(128).fill(0),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { min: 0, max: 2.0, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    } 
                }
            });
        }

        async function requestUSBConnection() {
            if (document.getElementById('simMode').checked) {
                simulateConnection();
                return;
            }

            try {
                appendLog("Solicitando permiso al sistema operativo...", "info");
                usbDevice = await navigator.usb.requestDevice({ 
                    filters: [{ vendorId: VID_FTDI }] 
                });

                appendLog(`Dispositivo seleccionado: ${usbDevice.productName}`, "data");
                
                await usbDevice.open();
                appendLog("SesiÃ³n USB abierta.", "data");
                
                if (usbDevice.configuration === null) {
                    await usbDevice.selectConfiguration(1);
                }
                await usbDevice.claimInterface(0);
                appendLog("Interfaz reclamada. Hardware listo para comandos.", "data");
                
                updateUIConnected(usbDevice.productName || "OnSite-W");

            } catch (err) {
                appendLog(`Fallo de conexiÃ³n: ${err.message}`, "error");
            }
        }

        function simulateConnection() {
            appendLog("Iniciando emulaciÃ³n virtual...", "info");
            setTimeout(() => {
                updateUIConnected("SIMULADOR MICRONIR");
                appendLog("Dispositivo virtual conectado.", "data");
            }, 500);
        }

        function updateUIConnected(name) {
            document.getElementById('deviceStatus').innerText = name;
            document.getElementById('dotStatus').classList.replace('bg-red-500', 'bg-emerald-500');
            document.getElementById('btnScan').disabled = false;
            document.getElementById('btnScan').classList.remove('opacity-40');
        }

        function triggerScan() {
            appendLog("Enviando comando de adquisiciÃ³n: START_SCAN", "info");
            document.getElementById('predictionValue').innerText = "---";
            document.getElementById('predictionValue').classList.add('animate-pulse');
            
            // SimulaciÃ³n de tiempo de integraciÃ³n (replicates: 500)
            setTimeout(() => {
                // 1. Generar espectro "realista" para alimento (curva NIR tÃ­pica)
                const spectrum = generatePseudoNIR();
                
                // 2. Aplicar matemÃ¡ticas PLS (PredicciÃ³n = Bias + Sum(Espectro * Betas))
                let prediction = calculatePLS(spectrum);
                
                // 3. Actualizar UI
                spectralChart.data.datasets[0].data = spectrum;
                spectralChart.update();
                
                document.getElementById('predictionValue').innerText = prediction.toFixed(2);
                document.getElementById('predictionValue').classList.remove('animate-pulse');
                appendLog(`Escaneado finalizado. Resultado: ${prediction.toFixed(2)}%`, "data");
            }, 1200);
        }

        function generatePseudoNIR() {
            // Genera una curva que sube hacia los 1450nm (humedad tÃ­pica)
            return Array.from({length: 128}, (_, i) => {
                const base = 0.6;
                const peak = Math.exp(-Math.pow(i - 80, 2) / 400) * 0.4; // Pico de absorciÃ³n
                const noise = (Math.random() - 0.5) * 0.01;
                return (base + peak + (i * 0.002) + noise).toFixed(4);
            });
        }

        function calculatePLS(spectrum) {
            let sum = 0;
            // Solo calculamos con los coeficientes que tenemos definidos
            const limit = Math.min(spectrum.length, BETA_COEFFICIENTS.length);
            
            for(let i=0; i < limit; i++) {
                sum += spectrum[i] * BETA_COEFFICIENTS[i];
            }
            
            // Formula: PredicciÃ³n = Bias + Suma de productos
            return MODEL_BIAS + sum;
        }

        function toggleSimMode() {
            const isSim = document.getElementById('simMode').checked;
            appendLog(`Cambio a modo ${isSim ? 'SIMULADO' : 'REAL'}`, "info");
        }

        function appendLog(msg, type) {
            const term = document.getElementById('terminal');
            const color = type === 'error' ? 'text-red-400' : (type === 'data' ? 'text-cyan-300' : 'text-emerald-400');
            term.innerHTML += `<div class="${color} mb-1"> <span class="opacity-50">[${new Date().toLocaleTimeString([], {hour12:false})}]</span> > ${msg}</div>`;
            term.scrollTop = term.scrollHeight;
        }

        function clearLog() {
            document.getElementById('terminal').innerHTML = "> Log reiniciado.";
        }
    </script>
</body>
</html>
