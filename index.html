!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR Controller - Maíz PLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white font-sans p-4">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">MicroNIR <span class="text-white">Analysis</span></h1>
                <p class="text-gray-400">Control de Sensor y Modelo de Maíz</p>
            </div>
            <div id="statusIndicator" class="px-4 py-2 rounded-full bg-red-900/30 border border-red-500 text-red-400 text-sm">
                Desconectado
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Panel de Control -->
            <div class="md:col-span-1 space-y-4">
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-4">Dispositivo</h2>
                    <button id="btnConnect" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all mb-3">
                        Conectar Sensor
                    </button>
                    <button id="btnScan" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50" disabled>
                        Iniciar Escaneo
                    </button>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="simMode" class="form-checkbox h-5 w-5 text-blue-600" checked>
                            <span class="text-gray-300">Modo Simulación</span>
                        </label>
                    </div>
                </div>

                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-2">Resultado PLS</h2>
                    <div id="resultValue" class="text-5xl font-mono text-center py-4 text-blue-400">--</div>
                    <p class="text-center text-gray-400 text-sm">Valor predicho (Maíz)</p>
                </div>
            </div>

            <!-- Gráfico de Espectro -->
            <div class="md:col-span-2 card p-6 rounded-2xl">
                <canvas id="spectrumChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES DEL MODELO MAÍZ ---
        const BIAS = -1.6224;
        const BETA_COEFFICIENTS = [
            -1.4243, -1.2185, -1.0422, -1.0125, -0.9984, -0.9152, -0.8421, -0.7324, -0.6541, -0.5823,
            -0.5124, -0.4523, -0.3821, -0.3121, -0.2241, -0.1524, -0.0821, -0.0124, 0.0524, 0.1241,
            // ... (Se asume la carga de los 128 coeficientes del archivo previo)
            // Para este ejemplo, llenaremos con un dummy array si faltan
        ];
        // Rellenar hasta 128 si es necesario
        while(BETA_COEFFICIENTS.length < 128) BETA_COEFFICIENTS.push(0.01 * Math.random());

        let device;
        let chart;

        // Inicialización de Gráfico
        const ctx = document.getElementById('spectrumChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 128}, (_, i) => 900 + (i * 6.25)), // Longitudes de onda aprox
                datasets: [{
                    label: 'Absorbancia / Intensidad',
                    borderColor: '#60a5fa',
                    borderWidth: 2,
                    data: Array(128).fill(0),
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                    x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Funciones de Control de Hardware (WebUSB)
        async function connectDevice() {
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x0403 }] }); // Vendor típico FTDI o VIAVI
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(0);
                
                document.getElementById('statusIndicator').textContent = "Conectado";
                document.getElementById('statusIndicator').className = "px-4 py-2 rounded-full bg-green-900/30 border border-green-500 text-green-400 text-sm";
                document.getElementById('btnScan').disabled = false;
                
                // Intentar encender lámpara enviando comando de inicialización
                // Nota: Los opcodes varían por modelo, esto es un intento genérico de activación
                await device.controlTransferOut({
                    requestType: 'vendor',
                    recipient: 'device',
                    request: 0x01, // Comando habitual de "Power On / Lamp On"
                    value: 0x0001,
                    index: 0x0000
                });

            } catch (err) {
                console.error(err);
                alert("Error de conexión: " + err.message);
            }
        }

        async function performScan() {
            const isSim = document.getElementById('simMode').checked;
            let spectrumData = new Float32Array(128);

            if (isSim) {
                // Simulación de lectura con ruido
                spectrumData = spectrumData.map(() => 0.5 + Math.random() * 0.2);
            } else {
                try {
                    // 1. Comando de "Start Integration" (Encender lámpara y capturar)
                    await device.controlTransferOut({
                        requestType: 'vendor',
                        recipient: 'device',
                        request: 0x02, // Request para iniciar escaneo
                        value: 0x0000,
                        index: 0x0000
                    });

                    // 2. Esperar tiempo de integración
                    await new Promise(r => setTimeout(r, 500));

                    // 3. Leer buffer de datos
                    const result = await device.transferIn(1, 256); // 128 píxeles * 2 bytes
                    const view = new DataView(result.data.buffer);
                    for (let i = 0; i < 128; i++) {
                        spectrumData[i] = view.getUint16(i * 2, true) / 65535.0; // Normalizado
                    }
                } catch (err) {
                    alert("Error capturando datos: " + err.message);
                    return;
                }
            }

            updateUI(spectrumData);
        }

        function updateUI(data) {
            // Actualizar Gráfico
            chart.data.datasets[0].data = Array.from(data);
            chart.update();

            // Calcular Predicción PLS: Y = Bias + Sum(Xi * Beta_i)
            let prediction = BIAS;
            for (let i = 0; i < 128; i++) {
                prediction += data[i] * BETA_COEFFICIENTS[i];
            }

            document.getElementById('resultValue').textContent = prediction.toFixed(4);
        }

        document.getElementById('btnConnect').addEventListener('click', connectDevice);
        document.getElementById('btnScan').addEventListener('click', performScan);

    </script>
</body>
</html>
