<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroNIR Controller - Diagn贸stico Avanzado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .terminal-glow { box-shadow: inset 0 0 20px rgba(34, 197, 94, 0.05); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-slate-200 font-sans p-4 sm:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black tracking-tight text-white">MicroNIR <span class="text-blue-500">Pro</span></h1>
                <p class="text-slate-400 font-medium">Panel de Adquisici贸n de Espectros</p>
            </div>
            <div id="statusIndicator" class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-slate-400 text-sm font-bold uppercase tracking-widest">
                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                Desconectado
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Controles Izquierda -->
            <div class="lg:col-span-4 space-y-6">
                <div class="card p-6 rounded-3xl space-y-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <span></span> Hardware
                    </h2>
                    <button id="btnConnect" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl transition-all shadow-lg shadow-blue-900/20 active:scale-95">
                        Conectar Sensor
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btnLampOn" class="bg-amber-600/20 hover:bg-amber-600/30 text-amber-500 border border-amber-600/30 font-bold py-2 rounded-xl transition-all disabled:opacity-30" disabled>
                            L谩mpara ON
                        </button>
                        <button id="btnLampOff" class="bg-slate-700/50 hover:bg-slate-700 text-slate-400 border border-slate-600/30 font-bold py-2 rounded-xl transition-all disabled:opacity-30" disabled>
                            L谩mpara OFF
                        </button>
                    </div>

                    <button id="btnScan" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-2xl transition-all disabled:opacity-30 shadow-lg shadow-emerald-900/20 active:scale-95" disabled>
                        MEDIR ESPECTRO
                    </button>
                    
                    <div class="pt-4 border-t border-slate-800">
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-slate-400 group-hover:text-white transition-colors">Modo Simulaci贸n</span>
                            <input type="checkbox" id="simMode" class="w-10 h-5 bg-slate-700 rounded-full appearance-none checked:bg-blue-600 transition-all relative after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:w-3 after:h-3 after:rounded-full after:transition-all checked:after:translate-x-5" checked>
                        </label>
                    </div>
                </div>

                <div class="card p-6 rounded-3xl text-center">
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-2">Predicci贸n Ma铆z (PLS)</h2>
                    <div id="resultValue" class="text-6xl font-black text-blue-400 drop-shadow-sm">--</div>
                    <div class="text-xs text-slate-500 mt-2">Valor calculado mediante Bias + BetaCoefficients</div>
                </div>
            </div>

            <!-- Visualizaci贸n Derecha -->
            <div class="lg:col-span-8 space-y-6">
                <div class="card p-6 rounded-3xl h-[400px] flex flex-col">
                    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span></span> Gr谩fico de Absorbancia
                    </h2>
                    <div class="flex-grow relative">
                        <canvas id="spectrumChart"></canvas>
                    </div>
                </div>

                <div class="card rounded-3xl overflow-hidden flex flex-col h-[200px] terminal-glow">
                    <div class="bg-slate-800/50 px-4 py-2 text-[10px] font-bold text-slate-500 border-b border-slate-700 flex justify-between">
                        <span>CONSOLA DE DIAGNSTICO</span>
                        <span id="retryCounter"></span>
                    </div>
                    <div id="log" class="p-4 font-mono text-xs text-emerald-400 overflow-y-auto space-y-1 flex-grow">
                        <div>> Sistema listo. Conecte el dispositivo para iniciar.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BIAS = -1.6224;
        const BETA_COEFFICIENTS = Array(128).fill(0).map(() => (Math.random() * 0.2) - 0.1); 

        let device;
        let chart;

        function addLog(msg, isError = false) {
            const logDiv = document.getElementById('log');
            if (!logDiv) return;
            const colorClass = isError ? 'text-red-400' : 'text-emerald-400';
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            logDiv.innerHTML += `<div class="${colorClass}"><span class="text-slate-600">[${time}]</span> > ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Setup Chart
        const ctx = document.getElementById('spectrumChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 128}, (_, i) => 900 + (i * 6.25)),
                datasets: [{
                    label: 'Absorbancia',
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    data: Array(128).fill(0),
                    fill: true,
                    pointRadius: 0,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' }, beginAtZero: true },
                    x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        async function connectDevice() {
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x0403 }] });
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(0);
                
                const statusInd = document.getElementById('statusIndicator');
                statusInd.innerHTML = `<div class="w-2 h-2 rounded-full bg-emerald-500"></div> Conectado`;
                statusInd.classList.replace('text-slate-400', 'text-emerald-400');
                
                document.getElementById('btnScan').disabled = false;
                document.getElementById('btnLampOn').disabled = false;
                document.getElementById('btnLampOff').disabled = false;
                addLog("Sensor MicroNIR vinculado y listo.");
            } catch (err) {
                addLog("Error conexi贸n: " + err.message, true);
            }
        }

        async function controlLamp(state) {
            try {
                const val = state ? 0x0001 : 0x0000;
                await device.controlTransferOut({
                    requestType: 'vendor', recipient: 'device', request: 0x01, value: val, index: 0x0000
                });
                addLog(`L谩mpara ${state ? 'ENCENDIDA' : 'APAGADA'} correctamente.`);
            } catch (err) {
                addLog("Error l谩mpara: " + err.message, true);
            }
        }

        async function performScan() {
            const isSim = document.getElementById('simMode').checked;
            let spectrumData = new Float32Array(128);

            if (isSim) {
                addLog("Simulando medici贸n quimiom茅trica...");
                for(let i=0; i<128; i++) spectrumData[i] = 0.2 + (Math.sin(i/10)*0.1) + (Math.random()*0.02);
            } else {
                try {
                    // Limpiar basura del buffer
                    addLog("Limpiando buffer de entrada...");
                    await device.transferIn(1, 64).catch(() => {});

                    addLog("Enviando comando de integraci贸n (0x02)...");
                    await device.controlTransferOut({
                        requestType: 'vendor', recipient: 'device', request: 0x02, value: 0x0000, index: 0x0000
                    });

                    let result;
                    let retries = 15; // Aumentado a 15 intentos para dar tiempo a los promedios
                    let success = false;
                    const retryCounter = document.getElementById('retryCounter');

                    while (retries > 0 && !success) {
                        retryCounter.textContent = `INTENTOS RESTANTES: ${retries}`;
                        await new Promise(r => setTimeout(r, 1000)); // Espera de 1s entre intentos

                        result = await device.transferIn(1, 256);

                        if (result.data.byteLength >= 256) {
                            success = true;
                        } else {
                            const hex = Array.from(new Uint8Array(result.data.buffer)).map(b => b.toString(16).padStart(2, '0')).join(' ');
                            addLog(`Hardware trabajando (${hex})...`);
                            retries--;
                        }
                    }

                    retryCounter.textContent = "";

                    if (!success) {
                        addLog("TIMEOUT: El hardware no liber贸 los datos. Intente encender la l谩mpara primero.", true);
                        return;
                    }

                    const view = new DataView(result.data.buffer);
                    for (let i = 0; i < 128; i++) {
                        spectrumData[i] = view.getUint16(i * 2, true) / 65535.0;
                    }
                    addLog("Espectro de 128 p铆xeles capturado.");
                } catch (err) {
                    addLog("Fallo cr铆tico en adquisici贸n: " + err.message, true);
                    return;
                }
            }
            updateUI(spectrumData);
        }

        function updateUI(data) {
            chart.data.datasets[0].data = Array.from(data);
            chart.update();

            let prediction = BIAS;
            for (let i = 0; i < 128; i++) {
                prediction += data[i] * BETA_COEFFICIENTS[i];
            }
            document.getElementById('resultValue').textContent = prediction.toFixed(4);
            addLog("Predicci贸n PLS actualizada.");
        }

        document.getElementById('btnConnect').addEventListener('click', connectDevice);
        document.getElementById('btnScan').addEventListener('click', performScan);
        document.getElementById('btnLampOn').addEventListener('click', () => controlLamp(true));
        document.getElementById('btnLampOff').addEventListener('click', () => controlLamp(false));
    </script>
</body>
</html>
